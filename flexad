#!/usr/bin/perl
# flexget-announced - daemon that announces new TV episodes

use strict;
use App::Daemon qw(daemonize);
use Getopt::Long;

GetOptions('help' =>  \&usage);

my $notifier = 'stumpish echo';
my $flexlog = "$ENV{HOME}/.flexget.log";
my $newEp = "";

print "Daemonizing, bye...\n";
daemonize();
while(1) {
  open(FLEX, "<", $flexlog) or die "$!\n";
  my @records = <FLEX>;
  close(FLEX);
  my @episodes;
  foreach my $record(@records) {
    next unless($record =~ /Downloading:/);
    $record =~ s/(?:\w+\s+){2}\w+:\s//;
    push(@episodes, $record) if $record =~ /(S[0-9]+)?(E[0-9]+)?(TV)/;
  }
  if($newEp ne @episodes[@episodes-1]) {
    $newEp = @episodes[@episodes-1];
    &notify($newEp);
  }

  sleep 300;
}

sub notify {
  my $toSend = shift;
  system("$notifier $toSend");
}

sub usage {
  print << "USAGE";
  $0 (start|stop|usage)
  $0 OPTIONS
  OPTIONS
    -X  run in foreground
    -l  log to file
    -u  run as user
    -p  pid file location

USAGE
exit 0;
}
